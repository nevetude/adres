<nav class="navbar navbar-expand-lg navbar-dark bg-transparent">
  <div class="container position-relative">
    <!-- Левая часть (кнопка темы и меню) -->
    <div class="d-flex align-items-center">
      <!-- Кнопка смены темы -->
      <button id="themeToggle" class="btn btn-outline-secondary btn-sm rounded-2 me-2">
        <i class="bi bi-moon-fill"></i>
      </button>

      <!-- Кнопка для мобильного меню (перенесена вправо) -->
    </div>

    <!-- Логотип (по центру) -->
    <% if (user && user.role === 'admin') { %>
      <span class="navbar-brand mx-auto position-absolute start-50 translate-middle-x">
        <img src="/images/misc/adres_logo.png" alt="Logo" width="100" height="60" class="d-inline-block align-top rounded">
      </span>
    <% } else { %>
      <a class="navbar-brand mx-auto position-absolute start-50 translate-middle-x" href="/">
        <img src="/images/misc/adres_logo.png" alt="Logo" width="80" height="50" class="d-inline-block align-top rounded">
      </a>
    <% } %>

    <!-- Кнопка для мобильного меню (добавлена справа) -->
    <button class="navbar-toggler border-0 ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Основное содержимое меню -->
    <div class="collapse navbar-collapse" id="navbarContent">
      <% if (!user || user.role !== 'admin') { %>
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-uppercase" href="#" id="menDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" onmouseover="if(window.innerWidth > 992) showDropdown('menDropdown')">
              Мужское
            </a>
            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="menDropdown">
              <li class="dropdown-submenu">
                <a class="dropdown-item dropdown-toggle text-uppercase" data-bs-toggle="collapse" href="#menTopClothing" role="button">Верхняя одежда</a>
                <ul class="dropdown-menu dropdown-sub collapse" id="menTopClothing">
                  <li><a class="dropdown-item text-uppercase" href="/category/Мужское/Футболки">Футболки</a></li>
                  <li><a class="dropdown-item text-uppercase" href="/category/Мужское/Худи">Худи</a></li>
                  <li><a class="dropdown-item text-uppercase" href="/category/Мужское/Рубашки">Рубашки</a></li>
                  <li><a class="dropdown-item text-uppercase" href="/category/Мужское/Пиджаки">Пиджаки</a></li>
                  <li><a class="dropdown-item text-uppercase" href="/category/Мужское/Пальто">Пальто</a></li>
                </ul>
              </li>
              <li class="dropdown-submenu">
                <a class="dropdown-item dropdown-toggle text-uppercase" data-bs-toggle="collapse" href="#menBottomClothing" role="button">Нижняя одежда</a>
                <ul class="dropdown-menu dropdown-sub collapse" id="menBottomClothing">
                  <li><a class="dropdown-item text-uppercase" href="/category/Мужское/Джинсы">Джинсы</a></li>
                  <li><a class="dropdown-item text-uppercase" href="/category/Мужское/Брюки">Брюки</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-uppercase" href="#" id="womenDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" onmouseover="if(window.innerWidth > 992) showDropdown('womenDropdown')">
              Женское
            </a>
            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="womenDropdown">
              <li class="dropdown-submenu">
                <a class="dropdown-item dropdown-toggle text-uppercase" data-bs-toggle="collapse" href="#womenTopClothing" role="button">Верхняя одежда</a>
                <ul class="dropdown-menu dropdown-sub collapse" id="womenTopClothing">
                  <li><a class="dropdown-item text-uppercase" href="/category/Женское/Футболки">Футболки</a></li>
                  <li><a class="dropdown-item text-uppercase" href="/category/Женское/Худи">Худи</a></li>
                  <li><a class="dropdown-item text-uppercase" href="/category/Женское/Рубашки">Рубашки</a></li>
                  <li><a class="dropdown-item text-uppercase" href="/category/Женское/Куртки">Куртки</a></li>
                  <li><a class="dropdown-item text-uppercase" href="/category/Женское/Пальто">Пальто</a></li>
                </ul>
              </li>
              <li class="dropdown-submenu">
                <a class="dropdown-item dropdown-toggle text-uppercase" data-bs-toggle="collapse" href="#womenBottomClothing" role="button">Нижняя одежда</a>
                <ul class="dropdown-menu dropdown-sub collapse" id="womenBottomClothing">
                  <li><a class="dropdown-item text-uppercase" href="/category/Женское/Джинсы">Джинсы</a></li>
                  <li><a class="dropdown-item text-uppercase" href="/category/Женское/Брюки">Брюки</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link text-uppercase" href="/products">Все товары</a>
          </li>
        </ul>
      <% } %>

      <!-- Правая часть (пользовательские элементы) -->
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <% if (user && user.role === 'admin') { %>
          <li class="nav-item">
            <a class="nav-link text-uppercase" href="/admin/products">Товары</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-uppercase" href="/admin/orders">Заказы</a>
          </li>
        <% } %>

        <% if (user) { %>
          <% if (user.role !== 'admin') { %>
            <!-- Для мобильной версии - объединенные элементы в dropdown -->
            <li class="nav-item dropdown d-lg-none">
              <a class="nav-link dropdown-toggle" href="#" id="mobileUserActions" role="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle"></i> Аккаунт
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="/orders"><i class="bi bi-bag me-2"></i>Мои заказы</a></li>
                <li><a class="dropdown-item" href="/favorites"><i class="bi bi-heart me-2"></i>Избранное</a></li>
                <li><a class="dropdown-item" href="/cart"><i class="bi bi-cart me-2"></i>Корзина</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/auth/logout"><i class="bi bi-box-arrow-right me-2"></i>Выйти</a></li>
              </ul>
            </li>
            
            <!-- Для десктопной версии - отдельные элементы -->
            <li class="nav-item d-none d-lg-block">
              <a class="nav-link text-uppercase" href="/orders">
                <i class="bi bi-bag"></i> Заказы
                <span id="ordersCounter" class="badge bg-danger" style="display: none;"></span>
              </a>
            </li>
            <li class="nav-item d-none d-lg-block">
              <a class="nav-link" href="/favorites">
                <i class="bi bi-heart"></i> Избранное
                <% if (favorites && favorites.length > 0) { %>
                  <span id="favoritesCounter" class="badge bg-danger"><%= favorites.length %></span>
                <% } %>
              </a>
            </li>
            <li class="nav-item d-none d-lg-block">
              <a class="nav-link" href="/cart">
                <i class="bi bi-cart"></i> Корзина
                <% if (cart && cart.length > 0) { %>
                  <span class="badge bg-danger"><%= cart.reduce((total, item) => total + item.quantity, 0) %></span>
                <% } %>
              </a>
            </li>
          <% } %>
          
          <!-- Основное меню пользователя -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
              <% if (user.role === 'admin') { %>
                <i class="bi bi-gear"></i>
              <% } else { %>
                <i class="bi bi-person"></i>
              <% } %>
              <%= user.name || user.email %>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="/auth/logout">Выйти</a></li>
            </ul>
          </li>
        <% } else { %>
          <li class="nav-item">
            <a class="nav-link text-uppercase" href="/auth/login">Войти</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-uppercase" href="/auth/register">Регистрация</a>
          </li>
        <% } %>
      </ul>
    </div>
  </div>
</nav>

<style>
  /* Базовые стили */
  .navbar {
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    transition: all 0.3s ease;
    font-size: 12px !important;
  }

  /* Темная тема по умолчанию */
  .navbar-dark {
    background-color: rgba(40, 40, 40, 0.85) !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .navbar-dark .navbar-brand,
  .navbar-dark .nav-link,
  .navbar-dark .dropdown-item {
    color: rgba(255, 255, 255, 0.9) !important;
  }
  
  .navbar-dark .dropdown-menu {
    background-color: rgba(50, 50, 50, 0.95) !important;
    border: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 12px !important;
  }
  
  .navbar-dark .dropdown-item:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
  }

  /* Светлая тема */
  [data-bs-theme="light"] .navbar-dark {
    background-color: rgba(255, 255, 255, 0.9) !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  [data-bs-theme="light"] .navbar-dark .navbar-brand,
  [data-bs-theme="light"] .navbar-dark .nav-link,
  [data-bs-theme="light"] .navbar-dark .dropdown-item {
    color: rgba(0, 0, 0, 0.9) !important;
  }
  
  [data-bs-theme="light"] .navbar-dark .dropdown-menu {
    background-color: rgba(255, 255, 255, 0.98) !important;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  [data-bs-theme="light"] .navbar-dark .dropdown-item:hover {
    background-color: rgba(0, 0, 0, 0.05) !important;
  }

  #themeToggle {
      border: 1px solid #ccc !important; /* Светло-серая рамка */
      border-radius: 4px !important; /* Квадратные углы */
      padding: 0.5rem !important; /* Увеличенные отступы */
      width: 36px; /* Фиксированная ширина */
      height: 36px; /* Фиксированная высота */
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px; /* Увеличенный отступ от краев */
  }

  
  .navbar-dark #themeToggle {
    border-color: #ccc !important; /* Светло-серая рамка для темной темы */
  }

  [data-bs-theme="light"] .navbar-dark #themeToggle {
      border-color: #999 !important; /* Чуть темнее для светлой темы */
  }


  /* Выпадающие меню */
  .dropdown-menu {
    transition: all 0.3s ease;
    opacity: 0;
    display: block;
    visibility: hidden;
    transform: translateY(10px);
  }
  
  .dropdown:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    transition-delay: 0.1s;
  }
  
  .dropdown-submenu {
    position: relative;
  }
  
  .dropdown-submenu .dropdown-menu.dropdown-sub {
    top: 0;
    left: 100%;
    margin-top: -0.5rem;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s ease;
  }
  
  .dropdown-submenu:hover .dropdown-menu.dropdown-sub {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    transition-delay: 0.2s;
  }

    .navbar-brand {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: block;
  }

  @media (max-width: 992px) {
      .navbar-brand {
          position: static;
          transform: none;
          margin: 0 auto;
      }

    .navbar-collapse {
      background-color: rgba(40, 40, 40, 0.95) !important;
      backdrop-filter: blur(15px);
      padding: 1rem;
      margin-top: 0.5rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    [data-bs-theme="light"] .navbar-collapse {
      background-color: rgba(255, 255, 255, 0.98) !important;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .dropdown-menu {
      background-color: rgba(30, 30, 30, 0.9) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      margin-left: 15px;
      opacity: 1;
      visibility: visible;
      transform: none;
      display: none;
    }
    
    .dropdown-menu.show {
      display: block;
    }
    
    [data-bs-theme="light"] .dropdown-menu {
      background-color: rgba(255, 255, 255, 0.98) !important;
      border: 1px solid rgba(0, 0, 0, 0.1) !important;
    }
    
    .dropdown-item {
      padding: 0.5rem 1.5rem !important;
      border-radius: 4px;
      margin: 2px 0;
    }
    
    .dropdown-item:hover {
      background-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    [data-bs-theme="light"] .dropdown-item:hover {
      background-color: rgba(0, 0, 0, 0.05) !important;
    }
    
    .dropdown-submenu .dropdown-menu.dropdown-sub {
      position: static;
      margin-left: 1rem;
      border-left: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .navbar-toggler {
      padding: 0.25rem 0.5rem;
      font-size: 1.25rem;
      line-height: 1;
      background-color: transparent;
      border: none;
      position: absolute;
      right: 15px;
    }
    
    .navbar-toggler:focus {
      box-shadow: none;
    }
    
    /* Исправление для подкатегорий в мобильной версии */
    .dropdown-submenu .dropdown-toggle::after {
      display: inline-block;
      margin-left: 0.255em;
      vertical-align: 0.255em;
      content: "";
      border-top: 0.3em solid;
      border-right: 0.3em solid transparent;
      border-bottom: 0;
      border-left: 0.3em solid transparent;
      float: right;
      margin-top: 0.5em;
    }
    
    .dropdown-submenu .dropdown-toggle[aria-expanded="true"]::after {
      transform: rotate(-180deg);
    }
    
    .dropdown-submenu .dropdown-sub {
      display: none;
    }
    
    .dropdown-submenu .dropdown-sub.show {
      display: block;
    }
  }

  /* Десктопная версия - выпадающее меню при наведении */
  @media (min-width: 992px) {
    .dropdown:hover .dropdown-menu {
      display: block;
      margin-top: 0;
    }
    
    .dropdown-menu {
      display: none;
      margin-top: 0;
    }
  }
</style>

<script>
  // Функции для управления выпадающими меню
  function showDropdown(id) {
    if (window.innerWidth > 992) {
      const dropdown = document.getElementById(id);
      const menu = dropdown.nextElementSibling;
      menu.style.opacity = '1';
      menu.style.visibility = 'visible';
      menu.style.transform = 'translateY(0)';
      dropdown.setAttribute('aria-expanded', 'true');
    }
  }
  
  function hideDropdown(id) {
    if (window.innerWidth > 992) {
      const dropdown = document.getElementById(id);
      const menu = dropdown.nextElementSibling;
      menu.style.opacity = '0';
      menu.style.visibility = 'hidden';
      menu.style.transform = 'translateY(10px)';
      dropdown.setAttribute('aria-expanded', 'false');
    }
  }

  function showSubmenu(element) {
    if (window.innerWidth > 992) {
      const submenu = element.querySelector('.dropdown-sub');
      submenu.style.opacity = '1';
      submenu.style.visibility = 'visible';
      submenu.style.transform = 'translateY(0)';
    }
  }
  
  function hideSubmenu(element) {
    if (window.innerWidth > 992) {
      const submenu = element.querySelector('.dropdown-sub');
      submenu.style.opacity = '0';
      submenu.style.visibility = 'hidden';
      submenu.style.transform = 'translateY(10px)';
    }
  }

  // Инициализация темы при загрузке
  document.addEventListener('DOMContentLoaded', function() {
    // Проверяем сохраненную тему
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-bs-theme', savedTheme);
    
    // Обновляем иконку кнопки
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.innerHTML = savedTheme === 'dark' 
        ? '<i class="bi bi-sun-fill"></i>' 
        : '<i class="bi bi-moon-fill"></i>';
      
      themeToggle.addEventListener('click', function() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-bs-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        this.innerHTML = newTheme === 'dark' 
          ? '<i class="bi bi-sun-fill"></i>' 
          : '<i class="bi bi-moon-fill"></i>';
      });
    }

    // Обновление счетчиков
    function updateNavCounters() {
      fetch('/cart/favorite/count')
        .then(response => response.json())
        .then(data => {
          const favCounter = document.getElementById('favoritesCounter');
          if (data.count > 0) {
            favCounter.textContent = data.count;
            favCounter.style.display = 'inline';
          } else {
            favCounter.style.display = 'none';
          }
        });

      fetch('/api/orders/count')
        .then(response => response.json())
        .then(data => {
          const ordersCounter = document.getElementById('ordersCounter');
          if (data.count > 0) {
            ordersCounter.textContent = data.count;
            ordersCounter.style.display = 'inline';
          } else {
            ordersCounter.style.display = 'none';
          }
        });
    }

    updateNavCounters();
    
    // Обработка кликов по подкатегориям в мобильной версии
    document.querySelectorAll('.dropdown-submenu .dropdown-toggle').forEach(toggle => {
      toggle.addEventListener('click', function(e) {
        if (window.innerWidth <= 992) {
          e.preventDefault();
          e.stopPropagation();
          const submenu = this.nextElementSibling;
          const isExpanded = this.getAttribute('aria-expanded') === 'true';
          
          // Закрываем все открытые подменю
          document.querySelectorAll('.dropdown-submenu .dropdown-sub').forEach(menu => {
            if (menu !== submenu) {
              menu.classList.remove('show');
            }
          });
          
          document.querySelectorAll('.dropdown-submenu .dropdown-toggle').forEach(t => {
            if (t !== this) {
              t.setAttribute('aria-expanded', 'false');
            }
          });
          
          // Переключаем текущее подменю
          if (isExpanded) {
            submenu.classList.remove('show');
            this.setAttribute('aria-expanded', 'false');
          } else {
            submenu.classList.add('show');
            this.setAttribute('aria-expanded', 'true');
          }
        }
      });
    });
  });
</script>